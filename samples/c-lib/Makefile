#==============================================================================
# Make Variables
#==============================================================================
OBJECTS  := $(patsubst %.c,./obj/%.o,$(wildcard *.c))

CFLAGS = -w -std=c99 -O2 -fPIC
LD_FLAGS := -shared -fPIC 

#
# The primary output build artifact
#
TARGET_NAME := libapi.so
TARGET      := build/$(TARGET_NAME)

#
# The following files will be removed when 'make clean' is invoked.
#
CLEAN_LIST  := $(wildcard $(TARGET))
CLEAN_LIST  += $(wildcard ../obj/*.o)

#
# The following directories will be removed when 'make clean' is invoked.
#
CLEAN_DIRS  := $(wildcard ./obj)
CLEAN_DIRS  += $(wildcard ./build)

#==============================================================================
# .PHONY targets don't generate a target file.
#==============================================================================
.PHONY: clean all test

#==============================================================================
# Make all
#==============================================================================
all: obj build $(TARGET)

#==============================================================================
# Make directories
#==============================================================================
build:
	@mkdir -p build

obj:
	@mkdir -p obj

#==============================================================================
# Compile object files from source code
#==============================================================================
$(OBJECTS): obj/%.o : %.c
	@echo "   Compiling "$<
	@gcc $(CFLAGS) -c -I./include $< -o $@

#==============================================================================
# Link object files to create shared library
#==============================================================================
$(TARGET): $(OBJECTS)
	@echo "   Linking shared library "$(TARGET_NAME)
	@gcc $(LD_FLAGS) -o $(TARGET) $(OBJECTS) $(LIBS)

#==============================================================================
# Remove files generated by the Make process
#==============================================================================
clean :
ifneq ($(strip $(CLEAN_LIST)),)
	@echo "   Removing generated files."
	@$(foreach item,$(CLEAN_LIST),rm $(item);)
endif
ifneq ($(strip $(CLEAN_DIRS)),)
	@echo "   Removing generated source directories."
	@$(foreach item,$(CLEAN_DIRS),rm -rf $(item);)
endif
